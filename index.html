<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- manifest.jsonã‚’èª­ã¿è¾¼ã‚€ -->
<link rel="manifest" href="manifest.json">
<!-- ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®è‰²ãªã©ã‚’æŒ‡å®šï¼ˆãŠå¥½ã¿ã§ï¼‰ -->
<meta name="theme-color" content="#000000">
<!-- iOSç”¨ã®ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
<link rel="apple-touch-icon" href="icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bujo Smart - Reliable Copy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .dot-grid {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #fcfcfc;
        }
        .tab-active { border-bottom: 2px solid #1f2937; font-weight: bold; color: #1f2937; }
        details summary::-webkit-details-marker { display:none; }
        summary { list-style: none; outline: none; }
            </style>
</head>
<body class="dot-grid min-h-screen font-sans text-gray-800 pb-32 overflow-x-hidden">

    <nav class="flex justify-center gap-8 p-4 bg-white/90 backdrop-blur-md border-b sticky top-0 z-20">
        <button onclick="switchTab('daily')" id="tab-daily" class="px-4 py-2 tab-active transition-all">Daily</button>
        <button onclick="switchTab('projects')" id="tab-projects" class="px-4 py-2 text-gray-400 transition-all">Projects</button>
    </nav>

    <div class="max-w-md mx-auto p-6">
        <div id="page-content">
            <!-- --- ãƒ‡ã‚¤ãƒªãƒ¼ãƒšãƒ¼ã‚¸ --- -->
            <section id="page-daily">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="changeDate(-1)" class="p-2 text-gray-400">â†</button>
                    <h2 id="display-date" class="text-xl font-bold font-mono text-center">2026.02.13 FRI</h2>
                    <button onclick="changeDate(1)" class="p-2 text-gray-400">â†’</button>
                </div>

                <div class="mb-6">
                    <!-- IDã‚’å¤‰æ›´ï¼šç¢ºå®Ÿã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‹¾ã†ãŸã‚ -->
                    <button id="copy-btn" onclick="copyWeeklyForAI()" class="w-full text-xs bg-gray-800 text-white py-4 rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <span>ğŸ“Š AIåˆ†æç”¨ã«ã‚³ãƒ”ãƒ¼ </span>
                        <span id="copy-status" class="hidden text-green-400 font-bold">âœ“ Copied</span>
                    </button>
                </div>

                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
                <div id="project-pulldowns" class="mb-8 space-y-2 text-sm"></div>

                <div id="daily-log-container" class="space-y-4 pt-6 border-t border-gray-200"></div>
            </section>

            <!-- --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ --- -->
            <section id="page-projects" class="hidden">
                <h2 class="text-2xl font-bold mb-6">Projects</h2>
                <div class="mb-8 bg-white p-4 rounded-xl border border-gray-200">
                    <input type="text" id="new-project-name" placeholder="æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå..." class="w-full p-2 border-b border-gray-100 focus:outline-none mb-4 bg-transparent">
                    <button onclick="addProject()" class="w-full bg-gray-100 py-2 rounded-lg font-bold text-sm">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ</button>
                </div>
                <div id="projects-container" class="space-y-6"></div>
            </section>
        </div>
    </div>

    <!-- å…¥åŠ›ãƒãƒ¼ -->
    <div id="daily-input-bar" class="fixed bottom-0 left-0 right-0 p-4 bg-white/95 border-t z-20 shadow-2xl">
        <div class="max-w-md mx-auto flex items-center gap-3">
            <span class="text-xl w-6 text-center text-gray-300">â—‹</span>
            <input type="text" id="todo-input" placeholder="ä½•ã‹æ›¸ã..." class="flex-1 p-2 focus:outline-none border-b border-gray-100 bg-transparent">
        </div>
    </div>

    <script>
        // --- è¨˜å·å®šç¾© ---
        const TYPES = [
            { symbol: 'â—‹', label: 'æœªå®Œäº†' },
            { symbol: 'â—', label: 'å®Œäº†' },
            { symbol: 'Ã—', label: 'ä¸­æ­¢' },
            { symbol: 'â†’', label: 'æ¬¡ã®æ—¥ã¸ç§»å‹•' },
            { symbol: 'â†‘', label: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ç§»å‹•' },
            { symbol: '-', label: 'ãƒ¡ãƒ¢' }
        ];

        let state = JSON.parse(localStorage.getItem('bujo_pro_v5')) || {
            currentDate: new Date().toISOString().split('T')[0],
            daily: {},
            projects: []
        };

        function save() {
            localStorage.setItem('bujo_pro_v5', JSON.stringify(state));
            render();
        }

        function switchTab(tab) {
            document.getElementById('page-daily').classList.toggle('hidden', tab !== 'daily');
            document.getElementById('page-projects').classList.toggle('hidden', tab !== 'projects');
            document.getElementById('daily-input-bar').classList.toggle('hidden', tab !== 'daily');
            document.getElementById('tab-daily').className = `px-4 py-2 ${tab === 'daily' ? 'tab-active' : 'text-gray-400'}`;
            document.getElementById('tab-projects').className = `px-4 py-2 ${tab === 'projects' ? 'tab-active' : 'text-gray-400'}`;
        }

       function changeDate(offset) {
    // æ—¥ä»˜ã‚’è¨ˆç®—ã™ã‚‹ã ã‘ã®å…ƒã®å½¢ã«æˆ»ã™
    const d = new Date(state.currentDate);
    d.setDate(d.getDate() + offset);
    state.currentDate = d.toISOString().split('T')[0];

    save(); // ä¿å­˜ã—ã¦ç”»é¢ã‚’æ›´æ–°
}
        function renderDaily() {
            const dateStr = state.currentDate;
            document.getElementById('display-date').textContent = dateStr.replace(/-/g, '.');
            const container = document.getElementById('daily-log-container');
            container.innerHTML = '';
            const logs = state.daily[dateStr] || [];
            
            logs.forEach((log, i) => {
            const div = document.createElement('div');
            div.className = "flex items-start gap-4 group"; // groupã‚’è¿½åŠ ï¼ˆå¾Œã§ä¾¿åˆ©ï¼‰
            
            // å·¦å´ã®è¨˜å·ãƒœã‚¿ãƒ³ï¼ˆä»Šã®ã¾ã¾ï¼‰
            const btn = document.createElement('button');
            btn.className = `w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-lg font-bold ${log.typeIndex === 1 ? 'bg-black text-white' : 'bg-gray-100 text-gray-500'}`;
            btn.textContent = TYPES[log.typeIndex].symbol;
            btn.onclick = () => {
                log.typeIndex = (log.typeIndex + 1) % TYPES.length;
                if(TYPES[log.typeIndex].symbol === 'â†’') migrateToNextDay(log.text);
                save();
            };

            // ä¸­å¤®ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä»Šã®ã¾ã¾ï¼‰
            const textSpan = document.createElement('span');
            textSpan.className = `flex-1 pt-1 ${log.typeIndex === 1 ? 'line-through text-gray-400' : ''}`;
            textSpan.textContent = log.text;

            // --- ã“ã“ã‹ã‚‰è¿½åŠ ï¼šå‰Šé™¤ãƒœã‚¿ãƒ³ ---
            const delBtn = document.createElement('button');
            delBtn.className = "text-gray-300 hover:text-red-400 p-1 text-lg"; // è–„ã„ã‚°ãƒ¬ãƒ¼ã§ã€è§¦ã‚‹ã¨èµ¤ããªã‚‹
            delBtn.innerHTML = "Ã—"; // å°ã•ãªÃ—å°
            delBtn.onclick = () => {
                if (confirm("ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { // é–“é•ãˆã¦æ¶ˆã•ãªã„ã‚ˆã†ã«ç¢ºèªã‚’å‡ºã™
                    state.daily[dateStr].splice(i, 1); // ãƒ‡ãƒ¼ã‚¿ã®iç•ªç›®ã‚’å‰Šé™¤ã™ã‚‹
                    save(); // ä¿å­˜ã—ã¦å†æç”»
                }
            };
            // --- ã“ã“ã¾ã§è¿½åŠ  ---

            div.appendChild(btn);
            div.appendChild(textSpan);
            div.appendChild(delBtn); // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ç”»é¢ã«è¿½åŠ 
            container.appendChild(div);
        });
            const pulldownArea = document.getElementById('project-pulldowns');
            pulldownArea.innerHTML = '';
            state.projects.forEach((proj, pIdx) => {
                const activeTasks = proj.tasks.filter(t => !t.completed);
                if(activeTasks.length === 0) return;
                const det = document.createElement('details');
                det.className = "bg-white border border-gray-100 rounded-xl overflow-hidden shadow-sm mb-2";
                det.innerHTML = `
                    <summary class="p-3 flex justify-between items-center cursor-pointer">
                        <span class="font-bold text-gray-600">${proj.title}</span>
                        <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded-full">${activeTasks.length}</span>
                    </summary>
                    <div class="p-2 space-y-1 bg-gray-50/50">
                        ${proj.tasks.map((t, tIdx) => !t.completed ? `
                            <div class="flex items-center gap-3 p-2 hover:bg-white rounded-lg cursor-pointer" onclick="syncCompleteTask(${pIdx}, ${tIdx})">
                                <span class="text-gray-300">â—‹</span>
                                <span class="text-gray-600">${t.text}</span>
                            </div>
                        ` : '').join('')}
                    </div>
                `;
                pulldownArea.appendChild(det);
            });
        }

        function syncCompleteTask(pIdx, tIdx) {
            const proj = state.projects[pIdx];
            const task = proj.tasks[tIdx];
            task.completed = true;
            const ds = state.currentDate;
            if(!state.daily[ds]) state.daily[ds] = [];
            state.daily[ds].push({ text: `${proj.title} - ${task.text}`, typeIndex: 1 });
            save();
        }

        function migrateToNextDay(text) {
            const d = new Date(state.currentDate);
            d.setDate(d.getDate() + 1);
            const target = d.toISOString().split('T')[0];
            if(!state.daily[target]) state.daily[target] = [];
            if(!state.daily[target].some(l => l.text === text)) {
                state.daily[target].push({ text: text, typeIndex: 0 });
            }
        }

        // --- æ”¹è‰¯ç‰ˆã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ ---
        async function copyWeeklyForAI() {
            let legend = "ã€è¨˜å·å‡¡ä¾‹ã€‘\n" + TYPES.map(t => `${t.symbol}: ${t.label}`).join('\n') + "\n\n";
            let content = "ã€æ´»å‹•ãƒ­ã‚°ï¼ˆç›´è¿‘7æ—¥é–“ï¼‰ã€‘\n\n";
            const d = new Date(state.currentDate);
            for(let i=0; i<7; i++) {
                const target = new Date(d);
                target.setDate(d.getDate() - (6 - i));
                const ds = target.toISOString().split('T')[0];
                const logs = state.daily[ds] || [];
                content += `â–  ${ds}\n` + (logs.length ? logs.map(l => `${TYPES[l.typeIndex].symbol} ${l.text}`).join('\n') : "(ãƒ­ã‚°ãªã—)") + "\n\n";
            }
            const finalOutput = legend + content;

            // 1. ã¾ãš modern API ã§è©¦è¡Œ
            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(finalOutput);
                    return showSuccess();
                } catch (e) {}
            }

            // 2. å¤±æ•—ã—ãŸå ´åˆã¯ textarea ã‚’ä½œã‚‹ä¼çµ±çš„æ‰‹æ³•
            const textArea = document.createElement("textarea");
            textArea.value = finalOutput;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) showSuccess();
            } catch (err) {
                // 3. æœ€çµ‚æ‰‹æ®µï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
                window.prompt("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š", finalOutput);
            }
            document.body.removeChild(textArea);
        }

        function showSuccess() {
            const status = document.getElementById('copy-status');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 2000);
        }

        // --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† ---
        function addProject() {
            const input = document.getElementById('new-project-name');
            if(!input.value) return;
            state.projects.push({ id: Date.now(), title: input.value, tasks: [] });
            input.value = '';
            save();
        }

        function renderProjects() {
            const container = document.getElementById('projects-container');
            container.innerHTML = '';
            state.projects.forEach((proj, pIdx) => {
                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-2xl border border-gray-100 shadow-sm";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-lg">${proj.title}</h3>
                        <button onclick="state.projects.splice(${pIdx}, 1); save();" class="text-red-200 text-xs">å‰Šé™¤</button>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${proj.tasks.map((t, tIdx) => `
                            <div class="flex items-center gap-3 text-sm ${t.completed ? 'opacity-30' : ''}">
                                <input type="checkbox" ${t.completed ? 'checked' : ''} onclick="state.projects[${pIdx}].tasks[${tIdx}].completed = !state.projects[${pIdx}].tasks[${tIdx}].completed; save();">
                                <span class="${t.completed ? 'line-through' : ''}">${t.text}</span>
                            </div>
                        `).join('')}
                    </div>
                    <input type="text" placeholder="+ ã‚¿ã‚¹ã‚¯è¿½åŠ ..." class="w-full text-sm p-2 bg-gray-50 rounded-lg focus:outline-none"
                        onkeypress="if(event.key==='Enter'){ state.projects[${pIdx}].tasks.push({text:this.value, completed:false}); save(); }">
                `;
                container.appendChild(div);
            });
        }

        function render() { renderDaily(); renderProjects(); }
        
        document.getElementById('todo-input').onkeypress = (e) => {
            if(e.key === 'Enter' && e.target.value) {
                const ds = state.currentDate;
                if(!state.daily[ds]) state.daily[ds] = [];
                state.daily[ds].push({ text: e.target.value, typeIndex: 0 });
                e.target.value = '';
                save();
            }
        };

        let startX = 0;
        document.addEventListener('touchstart', e => startX = e.touches[0].pageX);
        document.addEventListener('touchend', e => {
            let diff = startX - e.changedTouches[0].pageX;
            if(Math.abs(diff) > 100) changeDate(diff > 0 ? 1 : -1);
        });

        render();
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log("Service Worker Registered"))
      .catch(err => console.log("Service Worker Failed", err));
  }
</script>
</body>
</html>
